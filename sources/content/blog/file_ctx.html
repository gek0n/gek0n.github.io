---
title: Передача файлового контекста
description: Статья о передаче контекста ядерному устройству при открытии его из пользовательского пространства
keywords: createfile, file, zwcreatefile, ntcreatefile, context, ctx, driver, microsoft, windows
tags:
    - WIP
date: 21.03.2018
---
Для взаимодейтсвия пользовательских приложений с драйверами, работающими в режиме ядра используются системные устройства Device. Такой Device может быть создан и зарегистрирован в системе драйвером, после чего пользовательское приложение может открывать его через CreateFile, и читать/писать данные, а также посылать управляющие коды, используя функцию IOCTL.

В тех случаях, когда драйвер выполняет большое количество различных функций и должен производить обмен данными с разными частями пользовательского приложения (или с разными приложениями) по разному, требуется указывать драйверу, с каким приложением в данный момент он работает.

Существуют разные способы:

Описание способов...

### Недокументированный способ передачи файлового контекста
Для открытия устрйоства используется функция ZwCreateFile, которая принимает последними параметрами буффер EaBuffer и его длину EaLength. Согласно документации MSDN, 
> "..для устройств и промежуточных драйверов буфер должен быть NULL, а его длина должна быть 0..."
. Адрес, указывающий на данный буффер передаётся в `irp->AssociatedIrp.SystemBuffer`, следовательно может быть получен драйвером. Кажется хорошей идеей использовать данный буфер для указания контекста операции. Однако, если попробовать просто передать в него некоторое значение, то функция вернёт код ошибки.

Чтобы можно было использовать этот аргумент правильно, требуется открыть в дизассемблере функцию NtCreateFile, и посмотреть, что именно происходит с этим буффером, и как с ним работать.

...

Разобравшись видим, что на самом деле этот параметр указывает на внутреннюю структуру `FILE_FULL_EA_INFORMATION`, которая описывает элемент односвязного списка, имеющий имя и значение. Если данная структура сформирована неверно, то будет возвращён код ошибки.

При помощи данной структуры мы можем передать несколько дополнительных аргументов, которые будут доступны в драйвере. В их числе и контекст.

Пример реализации: